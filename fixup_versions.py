import re

from google.ads.googleads import client

sorted_versions = sorted(client._VALID_API_VERSIONS)


def replace_between_markers(content, marker_prefix, marker_suffix, replacement):
    replacement = "\n".join([marker_prefix, replacement, marker_suffix])
    new_content = re.sub(
        f"{marker_prefix}.+{marker_suffix}",
        replacement,
        content,
        flags=re.DOTALL,
    )
    return new_content


def fix_interceptors():
    interceptor_imports = []
    interceptor_request_types = []

    for version in sorted_versions:
        interceptor_imports.append(f"import google.ads.googleads.{version}.services")
        interceptor_request_types.append(
            f"google.ads.googleads.{version}.services.SearchGoogleAdsRequest"
        )
        interceptor_request_types.append(
            f"google.ads.googleads.{version}.services.SearchGoogleAdsStreamRequest"
        )

    interceptor_imports_prefix = "# Autogenerated imports"
    interceptor_imports_suffix = "# End of autogenerated imports"
    interceptor_request_types_prefix = "# Autogenerated request types"
    interceptor_request_types_suffix = "# End of autogenerated request types"

    interceptor_import_replacement = "\n".join(interceptor_imports)
    interceptor_request_types_replacement = ",\n".join(interceptor_request_types)

    interceptor_files = [
        "google-stubs/ads/googleads/interceptors/exception_interceptor.pyi",
        "google-stubs/ads/googleads/interceptors/logging_interceptor.pyi",
        "google-stubs/ads/googleads/interceptors/metadata_interceptor.pyi",
    ]

    for interceptor_file in interceptor_files:
        with open(interceptor_file) as f:
            interceptor_pyi = f.read()
        interceptor_pyi = replace_between_markers(
            interceptor_pyi,
            interceptor_imports_prefix,
            interceptor_imports_suffix,
            interceptor_import_replacement,
        )
        interceptor_pyi = replace_between_markers(
            interceptor_pyi,
            interceptor_request_types_prefix,
            interceptor_request_types_suffix,
            interceptor_request_types_replacement,
        )
        with open(interceptor_file, mode="w") as f:
            f.write(interceptor_pyi)


def fix_errors():
    error_imports = []
    error_types = []

    for version in sorted_versions:
        error_imports.append(
            f"from google.ads.googleads.{version}.errors import GoogleAdsFailure as GoogleAdsFailure{version.upper()}"
        )
        error_types.append(f"GoogleAdsFailure{version.upper()}")

    error_imports_prefix = "# Autogenerated imports"
    error_imports_suffix = "# End of autogenerated imports"
    error_types_prefix = "# Autogenerated failure types"
    error_types_suffix = "# End of autogenerated failure types"

    error_imports_replacement = "\n".join(error_imports)
    error_types_replacement = " | ".join(error_types)

    with open("google-stubs/ads/googleads/errors.pyi") as f:
        errors_pyi = f.read()

    errors_pyi = replace_between_markers(
        errors_pyi,
        error_imports_prefix,
        error_imports_suffix,
        error_imports_replacement,
    )
    errors_pyi = replace_between_markers(
        errors_pyi,
        error_types_prefix,
        error_types_suffix,
        error_types_replacement,
    )
    with open("google-stubs/ads/googleads/errors.pyi", mode="w") as f:
        f.write(errors_pyi)


def fix_client():
    default_version_import = (
        f"from google.ads.googleads import {client._DEFAULT_VERSION}"
    )

    default_version_import_prefix = "# Autogenerated import of latest version"
    default_version_import_suffix = "# End of autogenerated import of latest version"

    with open("google-stubs/ads/googleads/client.pyi") as f:
        client_pyi = f.read()

    client_pyi = replace_between_markers(
        client_pyi,
        default_version_import_prefix,
        default_version_import_suffix,
        default_version_import,
    )

    version_literals = []
    for version in sorted_versions:
        version_literals.append(f'_{version.upper()} = Literal["{version}"]')
    version_literals.append(
        f"_V = {' | '.join([f'_{version.upper()}' for version in sorted_versions])}"
    )

    version_literals_prefix = "# Autogenerated version literals"
    version_literals_suffix = "# End of autogenerated version literals"

    version_literals_replacement = "\n".join(version_literals)

    client_pyi = replace_between_markers(
        client_pyi,
        version_literals_prefix,
        version_literals_suffix,
        version_literals_replacement,
    )

    get_type_overload = f'    def get_type(cls, name: str, version: _V = "{client._DEFAULT_VERSION}") -> Any: ...'

    get_type_overload_prefix = "    # Autogenerated get_type overload"
    get_type_overload_suffix = "    # End of autogenerated get_type overload"

    client_pyi = replace_between_markers(
        client_pyi,
        get_type_overload_prefix,
        get_type_overload_suffix,
        get_type_overload,
    )

    with open("google-stubs/ads/googleads/client.pyi", mode="w") as f:
        f.write(client_pyi)


fix_interceptors()
fix_errors()
fix_client()
